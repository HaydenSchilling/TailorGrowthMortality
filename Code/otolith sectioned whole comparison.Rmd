---
title: "Whole v Sectioned otolith comparison"
output:
  html_document:
    code_folding: hide
  html_notebook: default
---


Load R libraries needed for analsysis (ggplot, FSA, BlandAltmanLeh and mulitplot function)
```{r warning=FALSE, message=FALSE}
library(ggplot2)
library(FSA)
library(BlandAltmanLeh)
source("R/functions.R")
```

Load Data
```{r}
mydata = read.csv('method comparison.csv', header=T)
```



Checking sectioned read 1 v sectioned read 2 for bias

```{r}
Sectioned.compare <- ageBias(SI1~SI2,data=mydata) 
summary(Sectioned.compare)
```

Therefore NO BIAS now check precision 

```{r}
Sect_Precision <- agePrecision(~SI1+SI2,data=mydata)
summary(Sect_Precision, what="precision")
```
NO BIAS and precision is OK, therefore we can use sectioned reads now need to average them for the comparison

Create average
```{r}
mydata$Mean_Sectioned <- (mydata$SI1 + mydata$SI2)/2
```

Same checks for whole otoliths

Checking Whole read 1 v whole read 2 for Bias
```{r}
Whole.compare <- ageBias(WI1~WI2,data=mydata) 
summary(Whole.compare)
```

Therefore NO BIAS in whole re-reads now check precision 

```{r}
Whole_Precision <- agePrecision(~WI1+WI2,data=mydata)
summary(Whole_Precision, what="precision")
```

NO BIAS and precision is OK, therefore we can use whole reads now need to average them for the comparison
```{r}
mydata$Mean_Whole <- (mydata$WI1 + mydata$WI2)/2
```


Make a plot of mean sectioned against mean whole, using loess smoother, grey is 95% Confidence Interval
```{r message=FALSE}
p1 <- ggplot(data = mydata, aes(y = Mean_Whole, x = Mean_Sectioned)) + 
  geom_jitter(size = 2, height = 0.1, width = 0.1) + geom_smooth() + theme_classic() + 
  geom_abline(slope = 1, size = 1, linetype = 2)  +
  ylab("Mean Whole Otolith Increments") + xlab("Mean Sectioned Otolith Increments") +
  theme(axis.title.x = element_text(face="bold", colour="black", size = 20),
        axis.text.x  = element_text(colour="black", size = 14), 
        axis.title.y = element_text(face="bold", colour="black", size = 20),
        axis.text.y  = element_text(colour="black", size = 14))
p1
ggsave("Output/whole_sectioned.pdf", width = 4, height = 4)
```

Difference between whole and sectioned
```{r}
mydata$Difference = mydata$Mean_Sectioned - mydata$Mean_Whole
```

Plot the difference in mean increment counts by length 
(I feel this is better for justifying use of whole otoliths on fish up to Xcm FL)
```{r message=FALSE}
p2 <- ggplot(data = mydata, aes(y = Difference, x = Length)) + geom_jitter(size = 2,height = 0.1) + geom_smooth() + 
  theme_classic() + geom_hline(yintercept = 0, linetype = 2, size = 1) + 
  xlab("Fork Length (cm)") + ylab("Differemce Between Mean Sectioned Increments \nand Mean Whole Increments") +
  theme(axis.title.x = element_text(face="bold", colour="black", size = 20),
        axis.text.x  = element_text(colour="black", size = 14), 
        axis.title.y = element_text(face="bold", colour="black", size = 20),
        axis.text.y  = element_text(colour="black", size = 14))
p2
ggsave("Output/Difference.pdf", width = 4, height = 4)
```

Plot both figures together - I THINK THIS IS THE KEY PLOT (fig 1 in paper?)
Grey is 95% CI
```{r message=FALSE}
multiplot(p1, p2, cols=2)

# To save image run lines below in console not notbook
#ggsave("poster pics/Fig1.pdf", plot = mp, width = 8, height = 4)
#ggsave("Output/Fig1.jpg", width = 8, height = 4)
```

```{r}
# Copy this to console
tiff("poster pics/fig1.tiff", height = 200, width = 240, units = 'mm', res = 300)
multiplot(p1, p2, cols=2)
dev.off()
```


Comparing bias and precision between whole and sectioned mean values
First check bias
```{r}
ab.ale <- ageBias(Mean_Whole~Mean_Sectioned,data=mydata) 
summary(ab.ale)
```

Therefore NO BIAS in comparision now check precision BUT NOTE THIS ANALYSIS DOESN'T SEEM TO LIKE MEAN COUNTS

```{r}
Compare_Precision <- agePrecision(~Mean_Whole+Mean_Sectioned,data=mydata)
summary(Compare_Precision, what="precision")
```
This shows between the two is NOT GREAT Precision but I think this is ok and shows whole otoliths are good enough overall


BlandAltman plots (from McBride 2015 ICES J Mar Sci)
```{r message=FALSE}
bland.altman.plot(mydata$Mean_Whole, mydata$Mean_Sectioned, graph.sys = "ggplot2", geom_count = TRUE) + geom_smooth()
```

