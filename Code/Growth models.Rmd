---
title: "Growth Modelling"
output:
  html_document:
    df_print: paged
---

Using Age Class data integratted with the daily aging which I did

Load packages

```{r}
library(dplyr)
library(ggplot2)
source("R/functions.R")
library(FSA)
library(nlstools)
library(MuMIn)
library(minpack.lm)
library(nnet)
```

Load the final data in and crop to only age >0 and adding 0.5 to all other age classes
```{r}
mydata <- read.csv("Final Adjusted Age Data for growth modelling.csv", header = T)
alldata <- mydata
mydata <- mydata[ which(mydata$AgeClass > 0),]

for (i in 1:nrow(mydata)) {
  if (mydata$AgeClass[i] >= 1) {
    mydata$AgeClass[i] <- mydata$AgeClass[i] + 0.5
  #} else if ((mydata$AgeClass[i] == 0)) {
  #  mydata$AgeClass[i] <- mydata$AgeClass[i] + 0.5
  } else {
    mydata$AgeClass[i] <- mydata$AgeClass[i]
  }
}

head(mydata)
```

Start with simple plot

Age length key testing
```{r}
alldata <- alldata %>% mutate(lcat10=lencat(FL..cm.,w=1))
alldata <- alldata %>% mutate(AgeClassWHOLE=lencat(AgeClass,w=1))
# alldata$lcat10 <- alldata$lcat10 + 1
head(alldata)
table(alldata$lcat10,alldata$AgeClassWHOLE)
alk.freq <- xtabs(~lcat10+AgeClassWHOLE,data=alldata)
rowSums(alk.freq)
alk <- prop.table(alk.freq,margin=1)
alk.round <- round(alk,3)
alk.round
write.csv(alk.round, "age length proportions.csv")

cc.mlr <- multinom(AgeClassWHOLE~lcat10,data=alldata,maxit=500) # library(nnet)

lens <- seq(20,80,1)
alk.sm <- predict(cc.mlr,data.frame(lcat10=lens),type="probs")
row.names(alk.sm) <- lens # for clarity
round(alk.sm,3)

alkPlot(alk.sm,type="area",pal="gray",showLegend=TRUE,
leg.cex=0.7,xlab="Total Length (mm)")
alkPlot(alk,type="bubble",xlab="Total Length (mm)")

```


```{r}
plot(FL..cm. ~ AgeClass , data=mydata, col = State)
```


Modelling growth now, Starting with von bert

To generate von bert growth models I am using the FSA package as follows, guess starting values for parameters

```{r}
mydata <- subset(mydata, AgeClass < 11)
vbTypical <- FL..cm.~Linf*(1-exp(-K*(AgeClass-t0)))
fitTypical <- nls(vbTypical,data=mydata,start=c(Linf = 80, K = 0.3, t0 = 0))
fitPlot(fitTypical,xlab="Age",ylab="Fork Length (cm)",main="")

VB_pars <- coef(fitTypical)
VB_pars
Linf <- VB_pars[1]
K <- VB_pars[2]
t0 <- VB_pars[3]
ageX <- seq(0,7, by = 0.01)
est_VB <- (Linf*(1-exp(-K*(ageX-t0))))
```



```{r}
overview(fitTypical)
```

```{r}
Boot_CIs_VB <- nlsBoot(fitTypical,niter=1000)
confint(Boot_CIs_VB,plot=TRUE)
```

Calculate AICc for von Bert
```{r}
k <- length(coef(fitTypical))
k

n <- nrow(mydata)
n

VB_AIC <- AIC(fitTypical, k = 3)
VB_AICc <- (VB_AIC + ((2 * (k + 1))/(n - k - 1)))
VB_AICc
```



Now to Calculate the Schnute growth curves, first we load our data

```{r}
grdata <- mydata
grdata$id <- mydata$ID
grdata$age <- mydata$AgeClass
grdata$len <- mydata$FL..cm.
#grdata <- subset(grdata, AgeClass < 11)

```


Now we load the growth model functions
```{r}
schnute1 <- function(age,alpha,beta,a1,a2,y1,y2)
{
  #function to return the fitted length from a schnute type 1 relationship
  t1 <- 1-exp(-alpha*(age-a1))
  t2 <- 1-exp(-alpha*(a2-a1))
  t3 <- y2^beta - y1^beta
  t4 <- y1^beta + t3*t1/t2
  return (t4^(1/beta))
}

schnute2 <- function(age,alpha,a1,a2,y1,y2)
{
  #function to return the fitted length from a schnute type 2 relationship
  t1 <- 1-exp(-alpha*(age-a1))
  t2 <- 1-exp(-alpha*(a2-a1))
  t3 <- log(y2/y1)
  return (y1*exp(t3*t1/t2))
}

schnute3 <- function(age,beta,a1,a2,y1,y2)
{
  #function to return the fitted length from a schnute type 3 relationship
  t1 <- (age-a1)/(a2-a1)
  t3 <- y2^beta - y1^beta
  t4 <- y1^beta + t3*t1
  return (t4^(1/beta))
}

schnute4 <- function(age,a1,a2,y1,y2)
{
  #function to return the fitted length from a schnute type 3 relationship
  t1 <- (age-a1)/(a2-a1)
  t2 <- log(y2/y1)
  return (y1*exp(t2*t1))
}

Gompetrz1 <- function(age, Linf, kappa, lamda)
{
  t2 <- (((log(lamda) - log(kappa)))/kappa)
    return (Linf*exp(-exp(-kappa*(age - t2))))
}
```


#
#
#
# SCHNUTE MODEL 1 ---- Does sort of work
#
#
#
#

To run the Schnute model #1, first we set some starting values, the two ages are pretty robust

```{r}
a1 = 1 # first age to model from
a2 = 4 # 2nd age to model from
y1I = 30 # Suggest average size at a1, don't do smaller than smallest fish at a1
y2I= 50 # suggest a size appropriate to a2
```

Run model and extract parameters, note this has been modified to get it to run

```{r, error=TRUE}
lower <- c(0.15, -4, 15, 30)
upper <- c(0.7, 0, 50, 70)
  
sch1 <- nls(len ~ schnute1(age,alpha,beta,a1,a2,y1,y2), start = list(alpha=0.5,beta=-2, y1=y1I,y2=y2I),
           control=nls.control(maxiter=10000, warnOnly = T), data=grdata, algorithm="port", lower=lower, upper=upper)
summary(sch1)
# Extract Parameters
Sch1_Pars <- coef(sch1)
```

Get Confidence Intervals and AIC

```{r}
Boot_CIs_sch1 <- nlsBoot(sch1)
Boot_CIs_sch1$bootCI

summary(Boot_CIs_sch1)

Sch1_AIC <- AIC(sch1)
Sch1_AIC

k <- length(coef(sch1))
k

n <- nrow(grdata)
n

Sch1_AIC <- AIC(sch1, k = k)
Sch1_AICc <- (Sch1_AIC + ((2 * (k + 1))/(n - k - 1)))
Sch1_AICc



```


To plot the resulting best fit, first set range of ages to graph, then get the parameters, run the eqtn, then make the plot

```{r, error=TRUE}
ageX <- seq(0,7,by=0.01)

alpha = Sch1_Pars[1]
beta = Sch1_Pars[2]
y1 = Sch1_Pars[3]
y2 = Sch1_Pars[4]

 a1=1; a2=4

# Getting points to plot as a line over the data (This is the schnute equation #1 but using Parameters indexes rather than names)
est_Sch1 <- (y1^beta + (y2^beta - y1^beta)*(1-exp(-alpha*(ageX-a1)))/(1-exp(-alpha*(a2-a1))))^(1/beta)

# Make the plot
plot(ageX, est_Sch1, type="l", ylim=c(0,80), xlab = "Age", ylab = "Fork Length")
points(grdata$age, grdata$len)
```


#
#
#
#
#     NOW SCHNUTE Growth Curve #2
#
#
#
#


# Set age range to model and approximate size at age
```{r}
a1 = 1
a2 = 4
y1I = 30 # Suggest average size at a1, don't do smaller than smallest fish at a1
y2I= 60 # suggest a size appropriate to a2
```

Run the model and get parameters
```{r}
sch2 <- nls(len ~ schnute2(age,alpha,a1,a2,y1,y2), start = list(alpha=0.1,y1=y1I,y2=y2I),
            control=nls.control(maxiter=10000), data=grdata)
summary(sch2)
# Extract Parameters
Sch2_Pars <- coef(sch2)
Sch2_Pars
```

Get Confidence Intervals using bootstrapping and get AIC
```{r}
Boot_CIs_sch2 <- nlsBoot(sch2)
summary(Boot_CIs_sch2)


k <- length(coef(sch2))
k

n <- nrow(grdata)
n

Sch2_AIC <- AIC(sch2, k = k)
Sch2_AICc <- (Sch2_AIC + ((2 * (k + 1))/(n - k - 1)))
Sch2_AICc
```

Make the graph
```{r}
alpha = Sch2_Pars[1]
y1 = Sch2_Pars[2]
y2 = Sch2_Pars[3]

# Set age range to graph
ageX <- seq(0,7, by = 0.01)

# Equation to plot
est_Sch2 <- (y1*exp(log(y2/y1)*(1-exp(-alpha*(ageX-a1)))/(1-exp(-alpha*(a2-a1)))))

# Make the plot
plot(ageX, est_Sch2, type="l", ylim=c(0,80), xlab = "Age", ylab = "Length")
points(grdata$age, grdata$len)
```

#
#
#
# Schnute growth curve #3
#
#
#
#
#
#


Set age range to model and approximate size at age
```{r}
a1 = 1 
a2 = 4
y1I = 35 # Suggest average size at a1, don't do smaller than smallest fish at a1
y2I= 50 # suggest a size appropriate to a2

library(minpack.lm) # use if convergence fails below

grdata2 <- subset(grdata, age < 13)

sch3 <- nlsLM(len ~ schnute3(age,beta,a1,a2,y1,y2), start = list(beta=1,y1=y1I,y2=y2I), #0.5 for no 0.5 age, use nlsLM if convergence fails
            control=nls.control(maxiter=10000), data=grdata2)



summary(sch3)
```

Extract Parameters for graphing
```{r}
# Extract Parameters
Sch3_Pars <- coef(sch3)
Sch3_Pars
```




To get Confidence Intervals using bootstrapping and get AIC
```{r}
Boot_CIs_sch3 <- nlsBoot(sch3)
summary(Boot_CIs_sch3)

k <- length(coef(sch3))
k

n <- nrow(grdata)
n

Sch3_AIC <- AIC(sch3, k = k)
Sch3_AIC
Sch3_AICc <- (Sch3_AIC + ((2 * (k + 1))/(n - k - 1)))
Sch3_AICc
```


Make graph, first get parameters from above
```{r}
beta = Sch3_Pars[1]
y1 = Sch3_Pars[2]
y2 = Sch3_Pars[3]

ageX <- seq(0,8, by = 0.01)
# Equation to plot
est_Sch3 <- ((y1^beta + (y2^beta - y1^beta)*((ageX-a1)/(a2-a1)))^(1/beta))

# Set age range to graph


# Make the plot
plot(ageX, est_Sch3, type="l", ylim=c(0,80), xlab = "Age", ylab = "Length")
points(grdata$age, grdata$len)
```

#
#
#
# Schnute growth curve # 4
#
#
#
#
#
#

Set age range to model and approximate size at age
```{r}
a1 = 1 
a2 = 4
y1I = 30 # Suggest average size at a1, don't do smaller than smallest fish at a1
y2I= 50 # suggest a size appropriate to a2

sch4 <- nls(len ~ schnute4(age,a1,a2,y1,y2), start = list(y1=y1I,y2=y2I),
            control=nls.control(maxiter=10000), data=grdata)
summary(sch4)
```

Extract Parameters
```{r}
Sch4_Pars <- coef(sch4)
Sch4_Pars
```

To get Confidence Intervals using bootstrapping and get AIC
```{r}
Boot_CIs_sch4 <- nlsBoot(sch4)
summary(Boot_CIs_sch4)

k <- length(coef(sch4))
k

n <- nrow(grdata)
n

Sch4_AIC <- AIC(sch4, k = k)
Sch4_AICc <- (Sch4_AIC + ((2 * (k + 1))/(n - k - 1)))
Sch4_AICc
```


Make graph of growth curve
```{r}
y1 = Sch4_Pars[1]
y2 = Sch4_Pars[2]

# Set age range to graph
ageX <- seq(0,7, by = 0.01)

# Equation to plot
est_Sch4 <- (y1*exp((log(y2/y1))*((ageX-a1)/(a2-a1))))



# Make the plot
plot(ageX, est_Sch4, type="l", ylim=c(0,80), xlab = "Age", ylab = "Length")
points(grdata$age, grdata$len)
```

#
#
#
#  Linear model
#
#
#

```{r}
lin_fit <- lm(len ~ age, data = grdata)
summary(lin_fit)
```

Bootstrapping (not done) and AICc


```{r}
Boot_CIs_lin <- confint(lin_fit)
Boot_CIs_lin

k <- length(coef(lin_fit))
k

n <- nrow(grdata)
n

LM_AIC <- AIC(lin_fit, k = k)
LM_AICc <- (LM_AIC + ((2 * (k + 1))/(n - k - 1)))
LM_AICc
```

Plot it up

```{r}
plot(len ~ age, data = grdata)
abline(lm(len ~ age, data = grdata))
```

#
#
# Gompertz Curve
#
#
#
#

```{r}
Linf = 100 
kappa = 0.2
lamda = 0.4

gomp_fit <- nls(len ~ Gompetrz1(age = age, Linf = Linf, kappa = kappa, lamda = lamda), start = list(Linf = Linf, kappa=kappa, lamda = lamda), control=nls.control(maxiter=10000), data=grdata)

summary(gomp_fit)
```


Extract Parameters
```{r}
Gomp_Pars <- coef(gomp_fit)
Gomp_Pars
```

To get Confidence Intervals using bootstrapping and get AIC
```{r}
Boot_CIs_gomp <- nlsBoot(gomp_fit)
summary(Boot_CIs_gomp)

Gomp_AIC <- AIC(gomp_fit)
Gomp_AIC

k <- length(coef(gomp_fit))
k

n <- nrow(grdata)
n

Gomp_AIC <- AIC(gomp_fit, k = k)
Gomp_AICc <- (Gomp_AIC + ((2 * (k + 1))/(n - k - 1)))
Gomp_AICc
```



Make graph of Gompertz growth curve
```{r}
Linf = Gomp_Pars[1]
kappa = Gomp_Pars[2]
lamda = Gomp_Pars[3]


# Set age range to graph
ageX <- seq(0,7, by = 0.01)

# Equation to plot
est_gomp <- ((Linf * exp(-exp(-kappa*(ageX - ((log(lamda)- log(kappa))/kappa))))))


# Make the plot
plot(ageX, est_gomp, type="l", ylim=c(0,80), xlab = "Age", ylab = "Length")
points(grdata$age, grdata$len)
```

#
#
# LOGISTIC MODEL
#
#
#
#


```{r}
Linf = 91
kappa = 0.5
t3 = 3

log_fit <- nls(len ~ (Linf*1/(1 + exp(-kappa*(age - t3)))), start = list(Linf = Linf, kappa=kappa, t3 = t3), control=nls.control(maxiter=10000), data=grdata)

log_fit
summary(log_fit)
                
```


Extract Parameters
```{r}
Log_Pars <- coef(log_fit)
Log_Pars
```

To get Confidence Intervals using bootstrapping and get AIC
```{r}
Boot_CIs_log <- nlsBoot(log_fit)
summary(Boot_CIs_log)

k <- length(coef(log_fit))
k

n <- nrow(grdata)
n

Log_AIC <- AIC(log_fit, k = k)
Log_AICc <- (Log_AIC + ((2 * (k + 1))/(n - k - 1)))
Log_AICc
```

Make graph of logistic growth curve


```{r}
Linf = Log_Pars[1]
kappa = Log_Pars[2]
t3 = Log_Pars[3]


# Set age range to graph
ageX <- seq(0,7, by = 0.01)

# Equation to plot
est_log <- (Linf*1/(1 + exp(-kappa*(ageX - t3))))


# Make the plot
plot(ageX, est_log, type="l", ylim=c(0,80), xlab = "Age", ylab = "Length")
points(grdata$age, grdata$len)
```

#
#
#
# Power Curve
#
#
#
#

```{r}
a0 = 0
a1 = 25
b = 0.4

power_fit <- nls(len ~ (a0 + a1 * (age^b)), start = list(a0 = a0, a1=a1, b = b), control=nls.control(maxiter=10000), data=grdata)

power_fit
summary(power_fit)
                
```

Extract Parameters
```{r}
Power_Pars <- coef(power_fit)
Power_Pars
```

To get Confidence Intervals using bootstrapping and get AIC
```{r}
Boot_CIs_power <- nlsBoot(power_fit)
summary(Boot_CIs_power)

Power_AIC <- AIC(power_fit)
Power_AIC

k <- length(coef(power_fit))
k

n <- nrow(grdata)
n

Power_AIC <- AIC(power_fit, k = k)
Power_AICc <- (Power_AIC + ((2 * (k + 1))/(n - k - 1)))
Power_AICc
```

Make graph of Power growth curve


```{r}
a0 = Power_Pars[1]
a1 = Power_Pars[2]
b = Power_Pars[3]


# Set age range to graph
ageX <- seq(0,7, by = 0.01)

# Equation to plot
est_power <- (a0 + a1 * (ageX^b))


# Make the plot
plot(ageX, est_power, type="l", ylim=c(0,80), xlab = "Age", ylab = "Length")
points(grdata$age, grdata$len)
legend("bottomright", legend = capture.output(round(Boot_CIs_power$bootCI, digits = 2)), cex = 0.75)
```



To compare all the models
```{r}
model_compare <- data.frame(VB_AICc, Sch1_AICc, Sch2_AICc, Sch3_AICc, Sch4_AICc, LM_AICc, Gomp_AICc, Log_AICc, Power_AICc) # removed Sch1_AIC as model would not work

sorted_models <- sort(model_compare, decreasing = FALSE)
print(paste("The best model to use based upon AICc is", names(sorted_models[1])))

#mod_list <- list(gomp_fit, lin_fit, log_fit, power_fit, sch1, sch2, sch3, sch4, svTypical)

model_compare

```

Make graphs
```{r}
par(mfrow=c(1,1)) 

plot(ageX, est_VB, type="l", ylim=c(0,80), xlab = "Age", ylab = "Length (cm)", main = paste("Von Bert, AICc =", round(VB_AICc, digits = 2)))
points(grdata$age, grdata$len)
#legend("bottomright", legend = capture.output(round(Boot_CIs_VB$bootCI, digits = 2)), cex = 0.75)

dev.copy(pdf,"Output/Growth Curve Comparisons/Von Bert Curve.pdf", width=8, height=6)
dev.off()
 


plot(ageX, est_Sch1, type="l", ylim=c(0,80), xlab = "Age", ylab = "Fork Length", main = paste("Schnute 1, AICc =", round(Sch2_AICc, digits = 2)))
points(grdata$age, grdata$len)
dev.copy(pdf,"Output/Growth Curve Comparisons/Schnute 1 Curve.pdf", width=8, height=6)
dev.off()

plot(ageX, est_Sch2, type="l", ylim=c(0,80), xlab = "Age", ylab = "Length (cm)", main = paste("Schnute 2, AICc =", round(Sch2_AICc, digits = 2)))
points(grdata$age, grdata$len)
#legend("bottomright", legend = capture.output(round(Boot_CIs_sch2$bootCI, digits = 2)), cex = 0.75)
 
dev.copy(pdf,"Output/Growth Curve Comparisons/Schnute 2 Curve.pdf", width=8, height=6)
dev.off()

plot(ageX, est_Sch3, type="l", ylim=c(0,90), xlab = "Age", ylab = "Length (cm)", main = paste("Schnute 3, AICc = ", round(Sch3_AICc, digits = 2)))
points(grdata$age, grdata$len)
#legend("bottomright", legend = capture.output(round(Boot_CIs_sch3$bootCI, digits = 2)), cex = 0.75)
 
dev.copy(pdf,"Output/Growth Curve Comparisons/Schnute 3 Curve.pdf", width=8, height=6)
dev.off()

plot(ageX, est_Sch4, type="l", ylim=c(0,80), xlab = "Age", ylab = "Length (cm)", main = paste("Schnute 4, AICc =", round(Sch4_AICc, digits = 2)))
points(grdata$age, grdata$len)
#legend("bottomright", legend = capture.output(round(Boot_CIs_sch4$bootCI, digits = 2)), cex = 0.75)
 
dev.copy(pdf,"Output/Growth Curve Comparisons/Schnute 4 Curve.pdf", width=8, height=6)
dev.off()

plot(len ~ age, data = grdata, ylim=c(0,80), xlab = "Age", ylab = "Length (cm)", main = paste("Linear, AICc =", round(LM_AICc, digits = 2)))
abline(lm(len ~ age, data = grdata))

dev.copy(pdf,"Output/Growth Curve Comparisons/Linear Curve.pdf", width=8, height=6)
dev.off()

plot(ageX, est_gomp, type="l", ylim=c(0,80), xlab = "Age", ylab = "Length (cm)", main = paste("Gompertz, AICc =", round(Gomp_AICc, digits = 2)))
points(grdata$age, grdata$len)
#legend("bottomright", legend = capture.output(round(Boot_CIs_gomp$bootCI, digits = 2)), cex = 0.75)
 
dev.copy(pdf,"Output/Growth Curve Comparisons/Gompertz Curve.pdf", width=8, height=6)
dev.off()

plot(ageX, est_log, type="l", ylim=c(0,80), xlab = "Age", ylab = "Length (cm)", main = paste("Logistic, AICc =", round(Log_AICc, digits = 2)))
points(grdata$age, grdata$len)
#legend("bottomright", legend = capture.output(round(Boot_CIs_log$bootCI, digits = 2)), cex = 0.75)
 
dev.copy(pdf,"Output/Growth Curve Comparisons/Logistic Curve.pdf", width=8, height=6)
dev.off()

plot(ageX, est_power, type="l", ylim=c(0,80), xlab = "Age", ylab = "Length (cm)", main = paste("Power, AICc =", round(Power_AICc, digits = 2)))
points(grdata$age, grdata$len)
#legend("bottomright", legend = capture.output(round(Boot_CIs_power$bootCI, digits = 2)), cex = 0.5)
 
dev.copy(pdf,"Output/Growth Curve Comparisons/Power Curve.pdf", width=8, height=6)
dev.off()
```

Daily Growth
```{r}
daily_data <- grdata[ which(grdata$AgeClass < 1),]
daily_data$age <- daily_data$age*365 # to get days not years
plot(len ~ age, data = daily_data, ylab = "Length (cm)", xlab = "Age (days)", xlim=c(0,250), ylim=c(0,20))
fit_daily <- lm(len ~ age, data = daily_data)
summary(fit_daily)
abline(fit_daily)

#dev.copy(pdf,"Output/Growth Curve Comparisons/Daily Growth.pdf", width=8, height=6)
#dev.off()

pd <- ggplot(daily_data, aes(x = age, y = len)) + geom_point(size = 2) + theme_classic() +
  xlim(c(0,250)) + ylim(c(0, 23)) + geom_smooth(method = "lm", se=F) +
  xlab("Age (Days)") + ylab("Fork Length (cm)") +
  theme(axis.title.x = element_text(face="bold", colour="black", size = 20),
        axis.text.x  = element_text(colour="black", size = 14), 
        axis.title.y = element_text(face="bold", colour="black", size = 20),
        axis.text.y  = element_text(colour="black", size = 14))
  pd
ggsave("poster pics/daily.tiff", plot = pd, width=240, height=150, units="mm", dpi=300)

```



COmpare sexes

```{r}

```


```{r}
# In excel randomly allocated U to either F or M equally
sepdata <- read.csv("sepsex.csv", header=T)
males <- sepdata[ !(sepdata$Sex == 'F'),]
females <- sepdata[!(sepdata$Sex == 'M'),]

a1 = 1 
a2 = 4
y1I = 30 # Suggest average size at a1, don't do smaller than smallest fish at a1
y2I= 50 # suggest a size appropriate to a2

#library(minpack.lm) #use if convergence fails below

sch3_F <- nlsLM(len ~ schnute3(age,beta,a1,a2,y1,y2), start = list(beta=2,y1=y1I,y2=y2I), #0.5 for no 0.5 age, use nlsLM if convergence fails
            control=nls.control(maxiter=10000), data=females)
summary(sch3_F)

sch3_M <- nlsLM(len ~ schnute3(age,beta,a1,a2,y1,y2), start = list(beta=2,y1=y1I,y2=y2I), #0.5 for no 0.5 age, use nlsLM if convergence fails
            control=nls.control(maxiter=10000), data=males)
summary(sch3_M)

sch32 <- nlsLM(len ~ schnute3(age,beta,a1,a2,y1,y2), start = list(beta=2,y1=y1I,y2=y2I), #0.5 for no 0.5 age, use nlsLM if convergence fails
            control=nls.control(maxiter=10000), data=grdata)
summary(sch32)
sch3_M$m$deviance()

```

```{r}
#extract RSS for each model
Combined.RSS<-sum(resid(sch32)^2) #RSS from combined model
separate_sex.RSS<-sum(resid(sch3_M)^2)+sum(resid(sch3_F)^2) # RSS from separate models which has been combined

#### Calculate LRT for each model
  #VB
  sch3.x2<--nrow(grdata)*log(separate_sex.RSS/Combined.RSS)#calculate chi sq
  df<-5 #number of degrees of freedom
sch3.p.val<-1-pchisq(sch3.x2,df)#calculated p value from df and x2

#results of individual candidate models
sch3.LRT.Result<-sch3.p.val<0.05 # true/false statement. True means significant difference
sch3.LRT.Result
sch3.p.val
```



```{r}
# Extract Parameters
Sch3_F_Pars <- coef(sch3_F)
Sch3_F_Pars

Sch3_M_Pars <- coef(sch3_M)
Sch3_M_Pars
```



```{r}



beta_F = Sch3_F_Pars[1]
y1_F = Sch3_F_Pars[2]
y2_F = Sch3_F_Pars[3]

# Set age range to graph
ageX <- seq(0,7, by = 0.01)
# Equation to plot
est_Sch3_F <- ((y1_F^beta_F + (y2_F^beta_F - y1_F^beta_F)*((ageX-a1)/(a2-a1)))^(1/beta_F))


beta_M = Sch3_M_Pars[1]
y1_M = Sch3_M_Pars[2]
y2_M = Sch3_M_Pars[3]

# Set age range to graph
ageX <- seq(0,7, by = 0.01)
# Equation to plot
est_Sch3_M <- ((y1_M^beta_M + (y2_M^beta_M - y1_M^beta_M)*((ageX-a1)/(a2-a1)))^(1/beta_M))

# Add Legend
names =c("Female", "Male", "Pooled")
col = c("red", "blue", "black")


# Make the plot
plot(ageX, est_Sch3_M, type="l", ylim=c(0,80), xlab = "Age", ylab = "Length", col="blue")
points(males$age, males$len, col="blue")
points((females$age+0.1), females$len, col="red")
points(ageX, est_Sch3_F, col="red", type = 'l')
points(ageX, est_Sch3, col="black", type = 'l')
legend("bottomright", col=col, legend=names, lty=c(1,1,1), pch=16, cex=1.5)
dev.copy(pdf,"Output/Growth Curve Comparisons/Schnute 3 by sex.pdf", width=8, height=6)
dev.off()


```

To compare between sexes, create 95% CI with bootstrapping and compare for overlap (probably a better way to do this)
```{r}
Boot_CIs_sch3_F <- nlsBoot(sch3_F)
summary(Boot_CIs_sch3_F)

Boot_CIs_sch3_M <- nlsBoot(sch3_M)
summary(Boot_CIs_sch3_M)


confint(Boot_CIs_sch3_F, plot = T)
title("Female")
dev.copy(pdf,"Output/Growth Curve Comparisons/Schnute 3 Female Parameters.pdf", width=8, height=6)
dev.off()
confint(Boot_CIs_sch3_M, plot = T)
title("Male")
dev.copy(pdf,"Output/Growth Curve Comparisons/Schnute 3 Male Parameters.pdf", width=8, height=6)
dev.off()
confint(Boot_CIs_sch3, plot = T)
title("Pooled")
dev.copy(pdf,"Output/Growth Curve Comparisons/Schnute 3 Parameters.pdf", width=8, height=6)
dev.off()


plotF <- data.frame(Boot_CIs_sch3_F$bootCI)
plotF$Sex <- "Female"
plotF

plotM <- data.frame(Boot_CIs_sch3_M$bootCI)
plotM$Sex <- "Male"
plotM

plotPooled <- data.frame(Boot_CIs_sch3$bootCI)
plotPooled
```


Make a plot with the old fish in it
```{r}
beta = 2.49
y1 = 25.46
y2 = 46.34

a1=1
a2=4

ageX <- seq(0,15, by = 0.01)
# Equation to plot
est_Sch3 <- ((y1^beta + (y2^beta - y1^beta)*((ageX-a1)/(a2-a1)))^(1/beta))

# Set age range to graph


# Make the plot
plot(ageX, est_Sch3, type="l", ylim=c(0,90), xlab = "Age", ylab = "Length")
points(grdata$age, grdata$FL..cm.)
        
```


Plot in supplementart material
Try ggplot
```{r}
datdat <- as.data.frame(cbind(ageX,est_Sch3))

p <- ggplot(grdata, aes(y = FL..cm. , x = age)) + geom_point(alpha = 0.5) +
  theme_classic() + geom_line(data= datdat, aes(x=ageX, y = est_Sch3)) +
  theme(axis.title.x = element_text(face="bold", colour="black", size = 20),
        axis.text.x  = element_text(colour="black", size = 14), 
        axis.title.y = element_text(face="bold", colour="black", size = 20),
        axis.text.y  = element_text(colour="black", size = 14)) +
  xlab("Age (years)") + ylab("Fork Length (cm)") +
  scale_y_continuous(breaks=seq(0,100,20)) +
  scale_x_continuous(breaks=seq(0,15,1))#+ ylim(0,100)
p

ggsave("Output/Size at age with outlier.pdf", height = 6, width = 8)
```


