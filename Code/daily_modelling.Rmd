---
title: "Growth Modelling"
output:
  html_document:
    df_print: paged
---

Using Age Class data integratted with the daily aging which I did

Load packages

```{r}
library(dplyr)
library(ggplot2)
source("../../R/functions.R")
library(FSA)
library(nlstools)
library(MuMIn)
library(minpack.lm)
library(nnet)
```

Load the final data in and crop to only age >0 and adding 0.5 to all other age classes
```{r}
mydata <- read.csv("../Data/Final Adjusted Age Data for growth modelling.csv", header = T)
alldata <- mydata
mydata <- mydata[ which(mydata$AgeClass > 0),]

for (i in 1:nrow(mydata)) {
  if (mydata$AgeClass[i] >= 1) {
    mydata$AgeClass[i] <- mydata$AgeClass[i] + 0.5
  #} else if ((mydata$AgeClass[i] == 0)) {
  #  mydata$AgeClass[i] <- mydata$AgeClass[i] + 0.5
  } else {
    mydata$AgeClass[i] <- mydata$AgeClass[i]
  }
}

head(mydata)

grdata <- mydata
grdata$id <- mydata$ID
grdata$age <- mydata$AgeClass
grdata$len <- mydata$FL..cm.
#grdata <- subset(grdata, AgeClass < 11)


```

Start with simple plot
Daily Growth
```{r}
daily_data <- grdata[ which(grdata$AgeClass < 1),]
daily_data$age <- daily_data$age*365 # to get days not years
daily_data$len <- daily_data$len*10
plot(len ~ age, data = daily_data, ylab = "Length (cm)", xlab = "Age (days)", xlim=c(0,250), ylim=c(0,230))
linear_fit <- lm((len) ~ age, data = daily_data)
summary(linear_fit)
abline(linear_fit)

#dev.copy(pdf,"Output/Growth Curve Comparisons/Daily Growth.pdf", width=8, height=6)
#dev.off()

pd <- ggplot(daily_data, aes(x = age, y = (len))) + geom_point(size = 2) + theme_classic() +
  xlim(c(0,250)) + ylim(c(0, 230)) + geom_smooth(method = "lm", se=F) +
  xlab("Age (Days)") + ylab("Fork Length (mm)") +
  theme(axis.title.x = element_text(face="bold", colour="black", size = 20),
        axis.text.x  = element_text(colour="black", size = 14), 
        axis.title.y = element_text(face="bold", colour="black", size = 20),
        axis.text.y  = element_text(colour="black", size = 14))
pd

linear_AIC <- AIC(linear_fit)
linear_AIC

k <- length(coef(linear_fit))
k

n <- nrow(grdata)
n

linear_AIC <- AIC(linear_fit, k = k)
linear_AICc <- (linear_AIC + ((2 * (k + 1))/(n - k - 1)))
linear_AICc


#ggsave("poster pics/daily.tiff", plot = pd, width=240, height=150, units="mm", dpi=300)

```

Modelling growth now, Starting with von bert

To generate von bert growth models I am using the FSA package as follows, guess starting values for parameters

```{r}
mydata <- daily_data
vbTypical <- len~Linf*(1-exp(-K*(age-t0)))
fitTypical <- nls(vbTypical,data=mydata,start=c(Linf = 800, K = 0.01, t0 = 0))
fitPlot(fitTypical,xlab="Age",ylab="Fork Length (cm)",main="")

VB_pars <- coef(fitTypical)
VB_pars
Linf <- VB_pars[1]
K <- VB_pars[2]
t0 <- VB_pars[3]
ageX <- seq(0,7, by = 0.01)
est_VB <- (Linf*(1-exp(-K*(ageX-t0))))
```



```{r}
overview(fitTypical)
```

```{r}
Boot_CIs_VB <- nlsBoot(fitTypical,niter=1000)
confint(Boot_CIs_VB,plot=TRUE)
```

Calculate AICc for von Bert
```{r}
k <- length(coef(fitTypical))
k

n <- nrow(mydata)
n

VB_AIC <- AIC(fitTypical, k = 3)
VB_AICc <- (VB_AIC + ((2 * (k + 1))/(n - k - 1)))
VB_AICc
```



Now to Calculate the Schnute growth curves, first we load our data

```{r}
grdata <- daily_data
grdata$id <- mydata$ID
grdata$age <- mydata$age
grdata$len <- mydata$FL..cm.
#grdata <- subset(grdata, AgeClass < 11)

```


Now we load the growth model functions
```{r}
schnute1 <- function(age,alpha,beta,a1,a2,y1,y2)
{
  #function to return the fitted length from a schnute type 1 relationship
  t1 <- 1-exp(-alpha*(age-a1))
  t2 <- 1-exp(-alpha*(a2-a1))
  t3 <- y2^beta - y1^beta
  t4 <- y1^beta + t3*t1/t2
  return (t4^(1/beta))
}

schnute2 <- function(age,alpha,a1,a2,y1,y2)
{
  #function to return the fitted length from a schnute type 2 relationship
  t1 <- 1-exp(-alpha*(age-a1))
  t2 <- 1-exp(-alpha*(a2-a1))
  t3 <- log(y2/y1)
  return (y1*exp(t3*t1/t2))
}

schnute3 <- function(age,beta,a1,a2,y1,y2)
{
  #function to return the fitted length from a schnute type 3 relationship
  t1 <- (age-a1)/(a2-a1)
  t3 <- y2^beta - y1^beta
  t4 <- y1^beta + t3*t1
  return (t4^(1/beta))
}

schnute4 <- function(age,a1,a2,y1,y2)
{
  #function to return the fitted length from a schnute type 3 relationship
  t1 <- (age-a1)/(a2-a1)
  t2 <- log(y2/y1)
  return (y1*exp(t2*t1))
}

Gompetrz1 <- function(age, Linf, kappa, lamda)
{
  
    return (Linf*exp(-exp(-kappa*(age - lamda))))
}
```


#
#
#
# SCHNUTE MODEL 1 ---- Does sort of work
#
#
#
#

To run the Schnute model #1, first we set some starting values, the two ages are pretty robust

```{r}
a1 = 50 # first age to model from
a2 = 200 # 2nd age to model from
y1I = 40 # Suggest average size at a1, don't do smaller than smallest fish at a1
y2I= 180 # suggest a size appropriate to a2
```

Run model and extract parameters, note this has been modified to get it to run

```{r, error=TRUE}
#lower <- c(0.15, -4, 15, 30)
#upper <- c(0.7, 0, 50, 70)
  
sch1 <- nls(len/10 ~ schnute1(age,alpha,beta,a1,a2,y1,y2), start = list(alpha=0.2,beta=2.0, y1=y1I,y2=y2I), control=nls.control(maxiter=10000, warnOnly = T), data=daily_data)
summary(sch1)
# Extract Parameters
Sch1_Pars <- coef(sch1)
```

Get Confidence Intervals and AIC

```{r}
Boot_CIs_sch1 <- nlsBoot(sch1)
Boot_CIs_sch1$bootCI

summary(Boot_CIs_sch1)

Sch1_AIC <- AIC(sch1)
Sch1_AIC

k <- length(coef(sch1))
k

n <- nrow(grdata)
n

Sch1_AIC <- AIC(sch1, k = k)
Sch1_AICc <- (Sch1_AIC + ((2 * (k + 1))/(n - k - 1)))
Sch1_AICc



```


To plot the resulting best fit, first set range of ages to graph, then get the parameters, run the eqtn, then make the plot

```{r, error=TRUE}
ageX <- seq(0,200,by=0.1)

alpha = 0.2
beta = 0.001
y1 = 40
y2 = 180

 a1=50; a2=200

# Getting points to plot as a line over the data (This is the schnute equation #1 but using Parameters indexes rather than names)
est_Sch1 <- (y1^beta + (y2^beta - y1^beta)*(1-exp(-alpha*(ageX-a1)))/(1-exp(-alpha*(a2-a1))))^(1/beta)

# Make the plot
plot(ageX, est_Sch1, type="l", ylim=c(0,80), xlab = "Age", ylab = "Fork Length")
points(grdata$age, grdata$len)
```


#
#
#
#
#     NOW SCHNUTE Growth Curve #2
#
#
#
#


# Set age range to model and approximate size at age
```{r}
a1 = 1
a2 = 4
y1I = 30 # Suggest average size at a1, don't do smaller than smallest fish at a1
y2I= 60 # suggest a size appropriate to a2
```

Run the model and get parameters
```{r}
sch2 <- nls(len ~ schnute2(age,alpha,a1,a2,y1,y2), start = list(alpha=0.1,y1=y1I,y2=y2I),
            control=nls.control(maxiter=10000), data=grdata)
summary(sch2)
# Extract Parameters
Sch2_Pars <- coef(sch2)
Sch2_Pars
```

Get Confidence Intervals using bootstrapping and get AIC
```{r}
Boot_CIs_sch2 <- nlsBoot(sch2)
summary(Boot_CIs_sch2)


k <- length(coef(sch2))
k

n <- nrow(grdata)
n

Sch2_AIC <- AIC(sch2, k = k)
Sch2_AICc <- (Sch2_AIC + ((2 * (k + 1))/(n - k - 1)))
Sch2_AICc
```

Make the graph
```{r}
alpha = Sch2_Pars[1]
y1 = Sch2_Pars[2]
y2 = Sch2_Pars[3]

# Set age range to graph
ageX <- seq(0,7, by = 0.01)

# Equation to plot
est_Sch2 <- (y1*exp(log(y2/y1)*(1-exp(-alpha*(ageX-a1)))/(1-exp(-alpha*(a2-a1)))))

# Make the plot
plot(ageX, est_Sch2, type="l", ylim=c(0,80), xlab = "Age", ylab = "Length")
points(grdata$age, grdata$len)
```

#
#
#
# Schnute growth curve #3
#
#
#
#
#
#


Set age range to model and approximate size at age
```{r}
a1 = 1 
a2 = 4
y1I = 35 # Suggest average size at a1, don't do smaller than smallest fish at a1
y2I= 50 # suggest a size appropriate to a2

library(minpack.lm) # use if convergence fails below

grdata2 <- subset(grdata, age < 13)

sch3 <- nlsLM(len ~ schnute3(age,beta,a1,a2,y1,y2), start = list(beta=1,y1=y1I,y2=y2I), #0.5 for no 0.5 age, use nlsLM if convergence fails
            control=nls.control(maxiter=10000), data=grdata2)



summary(sch3)
```

Extract Parameters for graphing
```{r}
# Extract Parameters
Sch3_Pars <- coef(sch3)
Sch3_Pars
```




To get Confidence Intervals using bootstrapping and get AIC
```{r}
Boot_CIs_sch3 <- nlsBoot(sch3)
summary(Boot_CIs_sch3)

k <- length(coef(sch3))
k

n <- nrow(grdata)
n

Sch3_AIC <- AIC(sch3, k = k)
Sch3_AIC
Sch3_AICc <- (Sch3_AIC + ((2 * (k + 1))/(n - k - 1)))
Sch3_AICc
```


Make graph, first get parameters from above
```{r}
beta = Sch3_Pars[1]
y1 = Sch3_Pars[2]
y2 = Sch3_Pars[3]

ageX <- seq(0,8, by = 0.01)
# Equation to plot
est_Sch3 <- ((y1^beta + (y2^beta - y1^beta)*((ageX-a1)/(a2-a1)))^(1/beta))

# Set age range to graph


# Make the plot
plot(ageX, est_Sch3, type="l", ylim=c(0,80), xlab = "Age", ylab = "Length")
points(grdata$age, grdata$len)
```

#
#
#
# Schnute growth curve # 4
#
#
#
#
#
#

Set age range to model and approximate size at age
```{r}
a1 = 1 
a2 = 4
y1I = 30 # Suggest average size at a1, don't do smaller than smallest fish at a1
y2I= 50 # suggest a size appropriate to a2

sch4 <- nls(len ~ schnute4(age,a1,a2,y1,y2), start = list(y1=y1I,y2=y2I),
            control=nls.control(maxiter=10000), data=grdata)
summary(sch4)
```

Extract Parameters
```{r}
Sch4_Pars <- coef(sch4)
Sch4_Pars
```

To get Confidence Intervals using bootstrapping and get AIC
```{r}
Boot_CIs_sch4 <- nlsBoot(sch4)
summary(Boot_CIs_sch4)

k <- length(coef(sch4))
k

n <- nrow(grdata)
n

Sch4_AIC <- AIC(sch4, k = k)
Sch4_AICc <- (Sch4_AIC + ((2 * (k + 1))/(n - k - 1)))
Sch4_AICc
```


Make graph of growth curve
```{r}
y1 = Sch4_Pars[1]
y2 = Sch4_Pars[2]

# Set age range to graph
ageX <- seq(0,200, by = 0.01)

# Equation to plot
est_Sch4 <- (y1*exp((log(y2/y1))*((ageX-a1)/(a2-a1))))



# Make the plot
plot(ageX, est_Sch4, type="l", ylim=c(0,80), xlab = "Age", ylab = "Length")
points(grdata$age, grdata$len)
```

#
#
#
#  Linear model
#
#
#

```{r}
lin_fit <- lm(len ~ age, data = daily_data)
summary(lin_fit)
```

Bootstrapping (not done) and AICc


```{r}
Boot_CIs_lin <- confint(lin_fit)
Boot_CIs_lin

k <- length(coef(lin_fit))
k

n <- nrow(grdata)
n

LM_AIC <- AIC(lin_fit, k = k)
LM_AICc <- (LM_AIC + ((2 * (k + 1))/(n - k - 1)))
LM_AICc
```

Plot it up

```{r}
plot(len ~ age, data = daily_data)
abline(lm(len ~ age, data = grdata))
```

#
#
# Gompertz Curve (Unified-gompertz growth function from Charlie)
#
#
#
#

```{r}
Linf = 250 
kappa = 0.02
lamda = 60

gomp_fit <- nls(len ~ Gompetrz1(age = age, Linf = Linf, kappa = kappa, lamda = lamda), start = list(Linf = Linf, kappa=kappa, lamda = lamda), control=nls.control(maxiter=10000), data=daily_data)

summary(gomp_fit)
```


Extract Parameters
```{r}
Gomp_Pars <- coef(gomp_fit)
Gomp_Pars
```

To get Confidence Intervals using bootstrapping and get AIC
```{r}
#Boot_CIs_gomp <- nlsBoot(gomp_fit)
#summary(Boot_CIs_gomp)

Gomp_AIC <- AIC(gomp_fit)
Gomp_AIC

k <- length(coef(gomp_fit))
k

n <- nrow(grdata)
n

Gomp_AIC <- AIC(gomp_fit, k = k)
Gomp_AICc <- (Gomp_AIC + ((2 * (k + 1))/(n - k - 1)))
Gomp_AICc
```



Make graph of Gompertz growth curve
```{r}
Linf = Gomp_Pars[1]
kappa = Gomp_Pars[2]
lamda = Gomp_Pars[3]

#Linf = 227
#kappa = 0.012
#lamda = 74

# Set age range to graph
ageX <- seq(0,300, by = 1)

# Equation to plot
est_gomp <- (Linf * exp(-exp(-kappa*(ageX - lamda))))
# SL ~ Linf * exp( -exp ( -G ( age - x0 ))

# Make the plot
plot(ageX, est_gomp, type="l", ylim=c(0,200), xlab = "Age", ylab = "Length")
points(daily_data$age, daily_data$len)
```

#
#
# LOGISTIC MODEL - working
#
#
#
#


```{r}
Linf = 20
kappa = 0.02
t3 = 100

log_fit <- nls((len/10) ~ (Linf*1/(1 + exp(-kappa*(age - t3)))), start = list(Linf = Linf, kappa=kappa, t3 = t3), control=nls.control(maxiter=10000), data=daily_data)

log_fit
summary(log_fit)
                
```


Extract Parameters
```{r}
Log_Pars <- coef(log_fit)
Log_Pars
```

To get Confidence Intervals using bootstrapping and get AIC
```{r}
Boot_CIs_log <- nlsBoot(log_fit)
summary(Boot_CIs_log)

k <- length(coef(log_fit))
k

n <- nrow(grdata)
n

Log_AIC <- AIC(log_fit, k = k)
Log_AICc <- (Log_AIC + ((2 * (k + 1))/(n - k - 1)))
Log_AICc
```

Make graph of logistic growth curve


```{r}
Linf = Log_Pars[1]
kappa = Log_Pars[2]
t3 = Log_Pars[3]


# Set age range to graph
ageX <- seq(min(daily_data$age),max(daily_data$age), by = 0.1)

# Equation to plot
est_log <- (Linf*1/(1 + exp(-kappa*(ageX - t3))))


# Make the plot
plot(ageX, est_log, type="l", ylim=c(0,20), xlab = "Age", ylab = "Length")
points(daily_data$age, daily_data$len/10)
```

#
#
#
# Power Curve
#
#
#
#

```{r}
a0 = -5
a1 = 1.2
b = 0.5

power_fit <- nls(len/10 ~ (a0 + a1 * (age^b)), start = list(a0 = a0, a1=a1, b = b), control=nls.control(maxiter=10000), data=daily_data)

power_fit
summary(power_fit)
                
```

Extract Parameters
```{r}
Power_Pars <- coef(power_fit)
Power_Pars
```

To get Confidence Intervals using bootstrapping and get AIC
```{r}
Boot_CIs_power <- nlsBoot(power_fit)
summary(Boot_CIs_power)

Power_AIC <- AIC(power_fit)
Power_AIC

k <- length(coef(power_fit))
k

n <- nrow(grdata)
n

Power_AIC <- AIC(power_fit, k = k)
Power_AICc <- (Power_AIC + ((2 * (k + 1))/(n - k - 1)))
Power_AICc
```

Make graph of Power growth curve


```{r}
a0 = Power_Pars[1]
a1 = Power_Pars[2]
b = Power_Pars[3]


# Set age range to graph
ageX <- seq(min(daily_data$age),max(daily_data$age), by = 0.1)

# Equation to plot
est_power <- (a0 + a1 * (ageX^b))


# Make the plot
plot(ageX, est_power, type="l", ylim=c(0,250), xlab = "Age", ylab = "Length")
points(daily_data$age, daily_data$len)
legend("bottomright", legend = capture.output(round(Boot_CIs_power$bootCI, digits = 2)), cex = 0.75)
```



To compare all the models
```{r}
model_compare <- data.frame(VB_AICc, linear_AICc, Gomp_AICc, Log_AICc, Power_AICc) # removed Sch1_AIC as model would not work

sorted_models <- sort(model_compare, decreasing = FALSE)
print(paste("The best model to use based upon AICc is", names(sorted_models[1])))

#mod_list <- list(gomp_fit, lin_fit, log_fit, power_fit, sch1, sch2, sch3, sch4, svTypical)

model_compare

```



Plot daily growth material
Try ggplot
```{r}
datdat <- as.data.frame(cbind(ageX, est_log))

p <- ggplot(daily_data, aes(y = len/10 , x = age)) + geom_point() +
  theme_classic() + geom_line(data= datdat, aes(x=ageX, y = est_log)) +
  theme(axis.title.x = element_text(face="bold", colour="black", size = 20),
        axis.text.x  = element_text(colour="black", size = 14), 
        axis.title.y = element_text(face="bold", colour="black", size = 20),
        axis.text.y  = element_text(colour="black", size = 14),
        axis.ticks = element_line(colour = "black")) +
  xlab("Age (days)") + ylab("Fork Length (cm)") + xlim(0,250) + ylim(0,22)
  #scale_y_continuous(breaks=seq(0,100,20)) +
  #scale_x_continuous(breaks=seq(0,15,1))#+ ylim(0,100)
p

#ggsave("Output/Daily Logistic Growth.pdf", height = 6, width = 8)
```

Bayesian Refitting
```{r}
library(brms)
hillprior <- c(
  set_prior("normal(20.5, 0.1)", nlpar = "Linf", lb=0),
  set_prior("normal(0.02, 0.001)", nlpar = "kappa"),
  set_prior("normal(95, 5)", nlpar = "t3"))#, 
# set_prior("normal(0.05, 0.2)", class="sigma"))


logB <- bf(len/10 ~ (Linf*1/(1 + exp(-kappa*(age - t3)))),
                Linf + kappa + t3 ~ 1, 
                # Nonlinear fit
                nl = TRUE)
get_prior(logB, data=daily_data)

hill_bayes_fit <- brm(
  logB,
  family=gaussian(), 
  data = daily_data,
  prior = hillprior ,
  control =
    list(adapt_delta = 0.9),
  cores=4,
  iter=50000,
  seed=1,
  thin = 5,
  file="brmlogB2.rds")

summary(hill_bayes_fit)
plot(hill_bayes_fit)

### plot
plot(conditional_effects(hill_bayes_fit, points=TRUE)) 
#plot(predict(hill_bayes_fit))


### Plot line + 95% CI interval + 95% Prediction Interval

predtimes <- seq(min(daily_data$age),max(daily_data$age),by=0.02)
hill_bayes_fitted <- fitted(hill_bayes_fit, 
                            newdata=list(age = predtimes)) %>% 
  as_tibble()
hill_bayes_pred <- predict(hill_bayes_fit,
                           newdata=list(age = predtimes)) %>%  
  as_tibble()
hill_bayes_ribbons <- tibble(
  age = predtimes,
  parentFraction=hill_bayes_fitted$Estimate,
  Estimate = hill_bayes_fitted$Estimate,
  pred_lower = hill_bayes_pred$Q2.5,
  pred_upper = hill_bayes_pred$Q97.5,
  fitted_lower = hill_bayes_fitted$Q2.5,
  fitted_upper = hill_bayes_fitted$Q97.5)
ggplot(data=daily_data, aes(x=age)) +
  geom_point(aes(y=`len`/10),size=2, alpha=0.7) +
  geom_ribbon(data=hill_bayes_ribbons, aes(ymin=pred_lower, ymax=pred_upper), 
              alpha=0.2)+#, fill=colourcodes[3]) +
  geom_ribbon(data=hill_bayes_ribbons, aes(ymin=fitted_lower, ymax=fitted_upper), 
              alpha=0.5)+#, fill=colourcodes[3]) +
  geom_line(data=hill_bayes_ribbons, aes(y=Estimate), colour="blue", 
            size=1)+
  theme_classic() +
  scale_x_continuous(breaks=seq(0,250,25))+
  theme(axis.title = element_text(face="bold", size=14),
        axis.text = element_text(size=12, colour="black"),
        axis.ticks = element_line(colour="black")) +
  labs(y="Fork Lenth (cm)", x= "Age (days)")

ggsave("../../Output/Bayesian logistic juvenile.png", dpi=600, width=21, height=14.8, units="cm")
ggsave("../../Output/Bayesian logistic juvenile.pdf", dpi=600, width=21, height=14.8, units="cm")
```

